#2018-06-23 学习笔记 @天羽蔚灵

##Sequelize入门
###连接数据库
```js
  const sequelize = new Sequelize('database', 'username', 'password', {
    host: 'localhost',
    dialect: 'mysql'|'mariadb'|'sqlite'|'postgres'|'mssql',
    pool: {
      max: 5,
      min: 0,
      idle: 10000
    },
    // 只适用于 SQLite
    storage: 'path/to/database.sqlite'
  });
  // 或者你也可以使用单个连接资源路径字符串
  var sequelize = new Sequelize('postgres://user:pass@example.com:5432/dbname');
```
###编写一个model
```js
  sequelize.define('name', {attributes}, {options})
```
###简单查询
####根据属性`Attributes`|查询：
```js
  model.findAll({
    attributes: ['foo', 'bar'] // 别名[['foo', ['bar', 'baz']]]
    })
```
相当于`SQL`|语句的：
```sql
  select foo, bar
  # 别名
  select foo, bar as baz
```
####使用聚集函数
```js
  Model.findAll({
    attributes: [[sequelize.fn('COUNT', sequelize.col('hats')), 'no_hats']]
  })
```
相当于`SQL`|:
```sql
  select count(hats) as no_hats
```
####使用更好的查询方式
方式一：
将需要查询的字段一一列出。
```js
  Model.findAll({
    attributes: ['id', 'foo', 'bar', 'baz', 'quz', [sequelize.fn('COUNT', sequelize.col('hats')), 'no_hats']]
  })
```
如果数据模型发生改变（比如字段名变更，删除）上面这种方式就不够好用了
方式二：
这种方式无论是添加还是删除属性它都是有效的，减少错误。
```js
  Model.findAll({
    attributes: { include: [[sequelize.fn('COUNT', sequelize.col('hats')), 'no_hats']] }
  })
```
查询时排除`baz`|：
```js
  Model.findAll({
    attributes: { exclude: ['baz'] }
  })
```
###条件查询Where
```js
  Post.findAll({
    where: {
      authorId: 2
    }
  });
  // SELECT * FROM post WHERE authorId = 2

  Post.findAll({
    where: {
      authorId: 12,
      status: 'active'
    }
  });
  // SELECT * FROM post WHERE authorId = 12 AND status = 'active';

  Post.destroy({
    where: {
      status: 'inactive'
    }
  });
  // DELETE FROM post WHERE status = 'inactive';

  Post.update({
    updatedAt: null,
  }, {
    where: {
      deletedAt: {
        $ne: null
      }
    }
  });
  // UPDATE post SET updatedAt = null WHERE deletedAt NOT NULL;

  Post.findAll({
    where: sequelize.where(sequelize.fn('char_length', sequelize.col('status')), 6)
  });
  // SELECT * FROM post WHERE char_length(status) = 6;
```
####`Operators`|操作符对应的`SQL`|语义
```js
  $and: {a: 5}           // AND (a = 5)
  $or: [{a: 5}, {a: 6}]  // (a = 5 OR a = 6)
  $gt: 6,                // > 6
  $gte: 6,               // >= 6
  $lt: 10,               // < 10
  $lte: 10,              // <= 10
  $ne: 20,               // != 20
  $not: true,            // IS NOT TRUE
  $between: [6, 10],     // BETWEEN 6 AND 10
  $notBetween: [11, 15], // NOT BETWEEN 11 AND 15
  $in: [1, 2],           // IN [1, 2]
  $notIn: [1, 2],        // NOT IN [1, 2]
  $like: '%hat',         // LIKE '%hat'
  $notLike: '%hat'       // NOT LIKE '%hat'
  $iLike: '%hat'         // ILIKE '%hat' (忽略大小写) (PG only)
  $notILike: '%hat'      // NOT ILIKE '%hat'  (PG only)
  $like: { $any: ['cat', 'hat']}
                         // LIKE ANY ARRAY['cat', 'hat'] - 也适用于 iLike 和 notLike
  $overlap: [1, 2]       // && [1, 2] (PG array overlap operator)
  $contains: [1, 2]      // @> [1, 2] (PG array contains operator)
  $contained: [1, 2]     // <@ [1, 2] (PG array contained by operator)
  $any: [2,3]            // ANY ARRAY[2, 3]::INTEGER (PG only)

  $col: 'user.organization_id' // = "user"."organization_id", with dialect specific column identifiers, PG in this example
```
####`Combinations`|组合条件
```js
  {
    rank: {
      $or: {
        $lt: 1000,
        $eq: null
      }
    }
  }
  // rank < 1000 OR rank IS NULL

  {
    createdAt: {
      $lt: new Date(),
      $gt: new Date(new Date() - 24 * 60 * 60 * 1000)
    }
  }
  // createdAt < [timestamp] AND createdAt > [timestamp]

  {
    $or: [
      {
        title: {
          $like: 'Boat%'
        }
      },
      {
        description: {
          $like: '%boat%'
        }
      }
    ]
  }
  // title LIKE 'Boat%' OR description LIKE '%boat%'
```
###`Definition`|定义常用查询
```js
  const Project = sequelize.define('project', {
    // Attributes
  }, {
    defaultScope: {
      where: {
        active: true
      }
    },
    scopes: {
      deleted: {
        where: {
          deleted: true
        }
      },
      activeUsers: {
        include: [
          { model: User, where: { active: true }}
        ]
      },
      // ...
    }
  });
```
当使用`Project.findAll()`|时会执行默认查询
也可以使用预定义的查询
```js
Project.scope('deleted', ...scopes).findAll()
```
####`limit`|限制返回数
```js
  {
    scope1: {
      where: {
        firstName: 'bob',
        age: {
          $gt: 20
        }
      },
      limit: 2
    },
    scope2: {
      where: {
        age: {
          $gt: 30
        }
      },
      limit: 10
    }
  }
```
